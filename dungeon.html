<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RPG - Five-Story Pagoda: Ultimate Edition</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding-bottom: 40px; }
        #main-layout { display: flex; gap: 10px; margin-top: 20px; }
        #game-window { position: relative; border: 4px solid #555; width: 400px; height: 400px; background: #000; overflow: hidden; }
        
        /* å¡”ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        #tower-ui { width: 80px; background: #332211; border: 4px solid #555; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 10px 0; }
        .floor-box { width: 50px; height: 50px; border: 2px solid #666; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; position: relative; }
        .current-floor { background: #aa8800; border-color: #ff0; box-shadow: 0 0 10px #ff0; }
        .current-floor::after { content: "â—€"; position: absolute; right: -20px; color: #ff0; }

        /* ã‚¯ãƒªã‚¢ç”»é¢ */
        #clear-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffd700; color: #000; display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000; text-align: center;
        }

        canvas { display: block; }
        #battle-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; z-index: 100; border: 4px double #fff; }
        #m-sprite { font-size: 70px; text-shadow: 0 0 10px red; }
        .g-bg { width: 100%; height: 8px; background: #333; border: 1px solid #666; margin-bottom: 5px; }
        .g-fill { height: 100%; width: 100%; transition: width 0.3s; }
        #e-hp-fill { background: #f00; }
        #p-hp-fill { background: #0f0; }
        #p-limit-fill { background: #ff0; width: 0%; }
        #battle-log { font-size: 12px; height: 60px; background: #111; width: 100%; padding: 5px; border: 1px solid #444; margin: 8px 0; overflow-y: hidden; color: #fff; }
        .commands { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        button { padding: 8px; background: #222; color: #fff; border: 1px solid #fff; cursor: pointer; touch-action: manipulation; }
        .limit-btn { color: #ff0; border-color: #ff0; display: none; }
        
        /* ã‚¿ãƒƒãƒæ“ä½œç”¨ãƒ‘ãƒãƒ« */
        #touch-panel { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .touch-row { display: flex; gap: 5px; }
        .t-btn { width: 65px; height: 65px; background: #444; border: 2px solid #888; border-radius: 10px; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; user-select: none; }
        .t-btn:active { background: #777; transform: scale(0.95); }

        /* å¸°é‚„ãƒãƒ¼ã‚¿ãƒ« */
        #home-portal-container { margin-top: 20px; }
        #home-portal-btn { background: #001133; color: #44ccff; border: 2px solid #44ccff; padding: 10px 20px; font-size: 16px; border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 0 10px rgba(68,204,255,0.3); }
        #home-portal-btn:hover .portal-icon { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .shake { animation: shake 0.2s; }
        @keyframes shake { 0%,100% {transform:translate(0,0);} 25% {transform:translate(4px,0);} 75% {transform:translate(-4px,0);} }
    </style>
</head>
<body>

<div id="main-layout">
    <div id="game-window">
        <canvas id="fieldCanvas" width="400" height="400"></canvas>
        <div id="clear-screen">
            <h1 style="margin:0;">CONGRATULATIONS!</h1>
            <div style="font-size: 80px;">ğŸ†</div>
            <p style="font-weight:bold;">äº”é‡ã®å¡”ã‚’åˆ¶è¦‡ã—ãŸï¼</p>
            <p>ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚Šã¾ã™...</p>
        </div>
        <div id="battle-overlay">
            <div id="m-name" style="font-weight:bold; color:#ff4d4d;"></div>
            <div id="m-sprite"></div>
            <div class="g-bg"><div id="e-hp-fill" class="g-fill"></div></div>
            <div id="battle-log"></div>
            <div class="g-bg"><div id="p-hp-fill" class="g-fill"></div></div>
            <div class="g-bg"><div id="p-limit-fill" class="g-fill"></div></div>
            <div class="commands">
                <button onclick="battleTurn('attack')">æ”»æ’ƒ</button>
                <button onclick="battleTurn('guard')">é˜²å¾¡</button>
                <button onclick="battleTurn('heal')">å›å¾©</button>
                <button onclick="battleTurn('run')">é€ƒã’ã‚‹</button>
                <button id="btn-lmt" class="limit-btn" onclick="battleTurn('limit')">æ¥µå¤§é­”æ³•</button>
            </div>
        </div>
    </div>
    <div id="tower-ui">
        <div class="floor-box" id="f5">5F</div>
        <div class="floor-box" id="f4">4F</div>
        <div class="floor-box" id="f3">3F</div>
        <div class="floor-box" id="f2">2F</div>
        <div class="floor-box" id="f1">1F</div>
    </div>
</div>

<div style="margin-top:10px;">ğŸ§™ LV: <span id="ui-lv">1</span> | HP: <span id="ui-hp">150</span></div>

<div id="touch-panel">
    <div class="touch-row"><div class="t-btn" onclick="handleTouch('ArrowUp')">â–²</div></div>
    <div class="touch-row">
        <div class="t-btn" onclick="handleTouch('ArrowLeft')">â—€</div>
        <div class="t-btn" onclick="handleTouch('ArrowDown')">â–¼</div>
        <div class="t-btn" onclick="handleTouch('ArrowRight')">â–¶</div>
    </div>
</div>

<div id="home-portal-container">
    <button id="home-portal-btn" onclick="returnToHome()">
        <span class="portal-icon">ğŸŒ€</span><span>æ‹ ç‚¹ã¸å¸°é‚„</span>
    </button>
</div>

<script>
const canvas = document.getElementById('fieldCanvas');
const ctx = canvas.getContext('2d');
const TILE = 40; const MAP_SZ = 20;
let gameState = 'field'; let currentFloor = 1; let bossDefeatedCount = 0;
let p = { x: 2, y: 2, hp: 150, maxHp: 150, atk: 25, limit: 0, lv: 1, guarding: false };
let enemies = []; let maze = [];

function initFloor(floor) {
    currentFloor = floor; bossDefeatedCount = 0;
    const floorColors = ["#2d5a27", "#273e5a", "#5a274e", "#5a4d27", "#4a1111"];
    window.currentWallColor = floorColors[floor-1];
    maze = Array.from({length: MAP_SZ}, (_, y) => Array.from({length: MAP_SZ}, (_, x) => (x===0 || y===0 || x===19 || y===19 || Math.random()<0.18) ? 1 : 0));
    maze[2][2] = 0; maze[2][3] = 0; maze[3][2] = 0;
    if (floor < 5 && Math.random() < 0.4) { maze[10+Math.floor(Math.random()*5)][10+Math.floor(Math.random()*5)] = 3; }
    if (floor < 5) { maze[18][18] = 2; maze[17][18] = 0; maze[18][17] = 0; }
    enemies = [];
    if (floor === 5) {
        const bosses = [{x:15,y:5,n:"ç‚ã®å®ˆè­·é¾",i:"ğŸ‰",m:"ãƒã€ãƒã‚«ãªâ€¦ç«ãŒæ¶ˆãˆã‚‹â€¦ï¼"},{x:5,y:15,n:"æ°·ã®é­”ç¥",i:"ğŸ§Š",m:"ä½“ãŒâ€¦æº¶ã‘ã¦ã„ãâ€¦ãƒƒï¼"},{x:15,y:15,n:"å½±ã®ç‹",i:"ğŸ‘¤",m:"å…‰ãŒâ€¦çœ©ã—ã™ãã‚‹â€¦ï¼"}];
        bosses.forEach(b => { enemies.push({x:b.x,y:b.y,name:b.n,icon:b.i,hp:400,maxHp:400,atk:45,isFinalBoss:true,deathMsg:b.m}); maze[b.y][b.x]=0; });
    } else {
        const icons = ["ğŸ‘¾", "ğŸ’€", "ğŸº", "ğŸ‘¹"];
        for(let i=0; i<4; i++) enemies.push({x:5+Math.floor(Math.random()*10),y:5+Math.floor(Math.random()*10),name:"æ•µå…µ",icon:icons[floor-1],hp:40+floor*20,maxHp:40+floor*20,atk:10+floor*5});
    }
    document.querySelectorAll('.floor-box').forEach(b => b.classList.remove('current-floor'));
    document.getElementById('f' + floor).classList.add('current-floor');
    p.x = 2; p.y = 2; drawField();
}

function drawField() {
    ctx.clearRect(0,0,400,400);
    let ox = Math.max(0, Math.min(p.x-5, MAP_SZ-10)), oy = Math.max(0, Math.min(p.y-5, MAP_SZ-10));
    for(let y=0; y<10; y++){
        for(let x=0; x<10; x++){
            let mx = x+ox, my = y+oy;
            if(maze[my][mx]===1){ ctx.fillStyle=window.currentWallColor; ctx.fillRect(x*TILE,y*TILE,TILE,TILE); }
            if(maze[my][mx]===2){ ctx.fillStyle="#f0f"; ctx.fillRect(x*TILE,y*TILE,TILE,TILE); }
            if(maze[my][mx]===3){ ctx.font="20px serif"; ctx.fillText("âš”ï¸", x*TILE+10, y*TILE+30); }
            enemies.forEach(en => { if(en.x===mx && en.y===my) ctx.fillText(en.icon, x*TILE+8, y*TILE+30); });
            if(mx===p.x && my===p.y){ ctx.font="24px serif"; ctx.fillText("ğŸ§™", x*TILE+8, y*TILE+30); }
        }
    }
    document.getElementById('ui-hp').innerText = p.hp;
    document.getElementById('ui-lv').innerText = p.lv;
}

// å…±é€šç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯
function movePlayer(key) {
    if(gameState !== 'field') return;
    let nx = p.x, ny = p.y;
    if(key==='ArrowUp') ny--; if(key==='ArrowDown') ny++;
    if(key==='ArrowLeft') nx--; if(key==='ArrowRight') nx++;
    if(maze[ny][nx] !== 1){
        p.x = nx; p.y = ny;
        if(maze[ny][nx]===2){ if(currentFloor < 5) initFloor(currentFloor+1); else showGameClear(); return; }
        if(maze[ny][nx]===3){ maze[ny][nx]=0; p.atk += 50; p.lv++; alert("ä¼èª¬ã®å‰£ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼"); }
        let hit = enemies.find(en => en.x === p.x && en.y === p.y);
        if(hit) startBattle(hit);
    }
    drawField();
}

window.addEventListener('keydown', e => movePlayer(e.key));
function handleTouch(key) { movePlayer(key); }

let currentE = null;
function startBattle(en) {
    gameState = 'battle'; currentE = en;
    document.getElementById('battle-overlay').style.display = 'flex';
    document.getElementById('m-name').innerText = en.name;
    document.getElementById('m-sprite').innerText = en.icon;
    addLog(`${en.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`); updateBattleUI();
}

async function battleTurn(type) {
    p.guarding = false;
    if(type==='attack'){
        let d = p.atk + Math.floor(Math.random()*10); currentE.hp -= d; p.limit = Math.min(100, p.limit+20);
        addLog(`â–¶ æ”»æ’ƒï¼ ${d}ãƒ€ãƒ¡`); effect('m-sprite');
    } else if(type==='limit'){
        let d = p.atk * 4; currentE.hp -= d; p.limit = 0;
        addLog(`ğŸ’¥ æ¥µå¤§é­”æ³•ï¼ ${d}ãƒ€ãƒ¡ï¼`, "#ff0"); effect('m-sprite');
    } else if(type==='heal'){ p.hp = Math.min(p.maxHp, p.hp+60); addLog(`â–¶ å›å¾©ï¼`); }
    else if(type==='run'){ addLog(`â–¶ é€ƒèµ°ï¼`); setTimeout(endBattle, 500); return; }
    updateBattleUI();
    if(currentE.hp <= 0){
        if(currentE.deathMsg) addLog(`ãƒœã‚¹ï¼š${currentE.deathMsg}`, "#ff4d4d");
        else addLog(`${currentE.name} ã‚’å€’ã—ãŸï¼`);
        enemies = enemies.filter(e => e !== currentE); setTimeout(endBattle, 1200); return;
    }
    await new Promise(r => setTimeout(r, 600)); enemyTurn();
}

function enemyTurn() {
    let d = Math.floor(currentE.atk * (0.8 + Math.random()*0.4));
    if(p.guarding) d = Math.floor(d/2.5);
    p.hp -= d; addLog(`âŒ æ•µã®æ”»æ’ƒï¼ ${d}ãƒ€ãƒ¡`); effect('game-window');
    updateBattleUI();
    if(p.hp <= 0){ alert("æ•—åŒ—..."); location.reload(); }
}

function updateBattleUI() {
    document.getElementById('e-hp-fill').style.width = (currentE.hp/currentE.maxHp*100) + "%";
    document.getElementById('p-hp-fill').style.width = (p.hp/p.maxHp*100) + "%";
    document.getElementById('p-limit-fill').style.width = p.limit + "%";
    document.getElementById('btn-lmt').style.display = (p.limit>=100) ? 'block' : 'none';
}

function endBattle() {
    if(currentE && currentE.isFinalBoss && currentE.hp <= 0){
        bossDefeatedCount++;
        if(bossDefeatedCount >= 3){ alert("å…¨ãƒœã‚¹æ’ƒç ´ï¼ä¸­å¤®ã«å‡ºå£å‡ºç¾ï¼"); maze[10][10] = 2; maze[9][10]=0; maze[11][10]=0; maze[10][9]=0; maze[10][11]=0; }
    }
    document.getElementById('battle-overlay').style.display = 'none';
    gameState = 'field'; currentE = null; drawField();
}

function showGameClear() {
    gameState = 'clear'; document.getElementById('clear-screen').style.display = 'flex';
    setTimeout(() => { window.location.href = "top.html"; }, 4000);
}

function returnToHome() {
    if(confirm("æ‹ ç‚¹ã¸å¸°é‚„ã—ã¾ã™ã‹ï¼Ÿ")) {
        const f = document.createElement('div'); f.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:#e0f7ff;z-index:10000;opacity:0;transition:0.5s';
        document.body.appendChild(f); setTimeout(()=>f.style.opacity='1',10);
        setTimeout(()=>window.location.href="top.html", 600);
    }
}

function addLog(m, c="white") { const l = document.getElementById('battle-log'); l.innerHTML = `<div style="color:${c}">${m}</div>` + l.innerHTML; }
function effect(id) { document.getElementById(id).classList.add('shake'); setTimeout(() => document.getElementById(id).classList.remove('shake'), 200); }

initFloor(1);
</script>
</body>
</html>
