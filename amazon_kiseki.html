<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIRACLE SYSTEM V5.0 | RECOVERY & TRIAL</title>
    <style>
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: 'Hiragino Kaku Gothic Pro', 'Courier New', monospace; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            overflow: hidden; 
            transition: background-color 1.5s, color 1.5s; 
        }
        
        /* 予兆エフェクト用のレイヤー */
        #effect-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        .hope-flash { background: radial-gradient(circle, transparent 10%, rgba(0, 200, 255, 0.25) 100%); }
        .danger-flash { background: radial-gradient(circle, transparent 10%, rgba(255, 0, 0, 0.25) 100%); }

        .main-layout { display: flex; gap: 40px; align-items: center; max-width: 1000px; padding: 20px; flex-wrap: wrap; justify-content: center; z-index: 60; }
        
        #loader { text-align: center; }
        .spinner { width: 60px; height: 60px; border: 6px solid #333; border-top: 6px solid #ffcc00; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #game-container { display: none; text-align: center; flex: 1; min-width: 320px; }
        h1 { font-size: 1.8rem; color: #ffcc00; text-shadow: 0 0 15px #ffcc00; }
        
        #roulette-box { width: 300px; height: 80px; border: 5px solid #fff; position: relative; overflow: hidden; background: #111; margin: 25px auto; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        #roulette-box::after { content: ""; position: absolute; top: 38px; left: 0; width: 100%; height: 4px; background: rgba(255, 255, 255, 0.8); pointer-events: none; z-index: 10; box-shadow: 0 0 10px #fff; }
        
        #roulette-list { position: absolute; top: 0; list-style: none; padding: 0; margin: 0; }
        .item { height: 80px; width: 300px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; border-bottom: 1px solid #333; box-sizing: border-box; }
        
        #spin-btn { padding: 18px 50px; font-size: 1.3rem; font-weight: bold; background: linear-gradient(45deg, #ffcc00, #ff6600); color: #fff; border: 3px solid #fff; border-radius: 60px; cursor: pointer; transition: 0.3s; }
        #spin-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #ffcc00; }

        #info-panel { background: rgba(255, 255, 255, 0.05); border-left: 4px solid #ffcc00; padding: 30px; text-align: left; min-width: 320px; display: none; border-radius: 15px; backdrop-filter: blur(5px); }
        #info-panel h3 { color: #ffcc00; margin-top: 0; border-bottom: 2px solid #ffcc00; text-align: center; }

        /* 撤退ボタン */
        #back-btn { margin-top: 20px; padding: 12px 30px; font-size: 0.9rem; background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid #666; border-radius: 5px; cursor: pointer; transition: 0.3s; width: 100%; }
        #back-btn:hover { background: rgba(255,255,255,0.2); color: #fff; border-color: #fff; }

        #result-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .miracle-bg { background-color: #ff0000; animation: flash 0.1s ease-in 3; }
        .doom-bg { background-color: #000; animation: doom-pulse 2s infinite; }
        @keyframes flash { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes doom-pulse { 0%, 100% { background-color: #000; } 50% { background-color: #2b0000; } }
        .win-text { font-size: 6rem; font-weight: 900; color: #fff; text-shadow: 6px 6px 0px #000; }
        .doom-text { color: #ff0000; text-shadow: 0 0 30px #ff0000; }
        
        #destroy-btn-final { padding: 25px 50px; background: #ff0000; color: #fff; border: 4px solid #fff; font-weight: bold; font-size: 1.8rem; cursor: pointer; margin-top: 30px; border-radius: 10px; box-shadow: 0 0 20px #ff0000; }

        @keyframes shake { 0% { transform: translate(0,0); } 10% { transform: translate(-5px, -5px); } 20% { transform: translate(5px, 5px); } 100% { transform: translate(0,0); } }
        .shaking { animation: shake 0.1s infinite; }
        .noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 2px); pointer-events: none; opacity: 0; z-index: 200; }
        #message-box { display: none; font-size: 1.8rem; font-weight: bold; line-height: 2; z-index: 300; max-width: 80%; text-align: center;}
        .fade-out { transition: opacity 2s; opacity: 0; }
    </style>
</head>
<body id="body">

<div id="effect-layer"></div>

<div id="loader">
    <div class="spinner"></div>
    <div id="loading-text">SYSTEM BOOTING...</div>
</div>

<div class="main-layout" id="main-ui" style="display:none;">
    <div id="game-container">
        <h1>RECOVERY SYSTEM V5.0</h1>
        <div id="roulette-box">
            <ul id="roulette-list"></ul>
        </div>
        <button id="spin-btn" onclick="startRoulette()">奇跡を信じて回す</button>
    </div>
    <div id="info-panel">
        <h3>PROBABILITY: 50%</h3>
        <ul style="list-style: none; padding: 0;">
            <li><span style="color:#ffcc00;">●</span> 奇跡当選：Amazonへ転送</li>
            <li><span style="color:#ff4444;">●</span> 世界滅亡：システム破棄</li>
        </ul>
        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">
        <button id="back-btn" onclick="exitSystem()">試練をやめて帰還する</button>
    </div> 
</div>

<div id="result-overlay">
    <h2 class="win-text" id="win-title">奇跡当選</h2>
    <p style="font-size: 2rem; font-weight: bold;" id="win-status">AUTHENTICATED</p>
    <p id="countdown" style="font-size: 1.5rem;">まもなく転送します...</p>
    <button id="destroy-btn-final" style="display:none;" onclick="startTheEnd()">世界を滅ぼす</button>
</div>

<div id="message-box"></div>
<div class="noise" id="noise"></div>

<script>
    let audioCtx;
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }
    document.addEventListener('click', initAudio, { once: true });

    function playSound(freq, type, duration, volume = 0.1) {
        if(!audioCtx || audioCtx.state === 'suspended') return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    // インデックスへの帰還
    function exitSystem() {
        if(confirm("試練を中断し、インデックスページに戻りますか？")) {
            localStorage.setItem('extinction_count', '0');
            window.location.href = "index.html"; 
        }
    }

    // アイテム生成
    const items = ["★奇跡当選★", "世界滅亡"];
    const listEl = document.getElementById('roulette-list');
    for(let i=0; i<100; i++) {
        const li = document.createElement('li');
        li.className = 'item';
        const text = items[i % items.length];
        li.innerText = text;
        li.style.color = text === "★奇跡当選★" ? "#ffcc00" : "#ff4444";
        listEl.appendChild(li);
    }

    window.onload = function() {
        const loadingTexts = ["データ構築中...", "権限確認中...", "期待値調整中...", "ほぼ完了..."];
        let ltIdx = 0;
        const ltInterval = setInterval(() => {
            if(ltIdx < loadingTexts.length) {
                document.getElementById('loading-text').innerText = loadingTexts[ltIdx++];
                playSound(440, 'square', 0.05, 0.03);
            } else {
                clearInterval(ltInterval);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-ui').style.display = 'flex';
                document.getElementById('game-container').style.display = 'block';
                document.getElementById('info-panel').style.display = 'block';
                playSound(1000, 'sine', 0.4, 0.08);
            }
        }, 800); 
    };

    function startRoulette() {
        initAudio();
        document.getElementById('spin-btn').style.visibility = 'hidden';
        document.getElementById('back-btn').style.display = 'none';

        // 50%の確率設定
        const isMiracle = Math.random() < 0.5;
        const res = isMiracle 
            ? { type: "MIRACLE", url: "https://www.amazon.jp/hz/wishlist/ls/204FNL7FFUQPZ?ref_=wl_share", itemIdx: 0 }
            : { type: "DESTROY", url: "DESTROY", itemIdx: 1 };

        const effectLayer = document.getElementById('effect-layer');

        // 予兆エフェクトの開始
        setTimeout(() => {
            effectLayer.className = isMiracle ? 'hope-flash' : 'danger-flash';
            effectLayer.style.opacity = "1";
            playSound(isMiracle ? 800 : 200, 'sine', 1.5, 0.05);
        }, 1200);

        let count = 0;
        let pos = 0;
        const spinLoop = setInterval(() => {
            pos -= 80;
            listEl.style.top = pos + 'px';
            playSound(1200, 'sine', 0.02, 0.03); 
            
            count++;
            if (count > 30) {
                clearInterval(spinLoop);
                const targetSet = 40; 
                const finalPos = -( (targetSet * items.length * 80) + (res.itemIdx * 80) );
                
                listEl.style.transition = "top 3.5s cubic-bezier(0.15, 0, 0.15, 1)";
                listEl.style.top = finalPos + "px";

                // 停止演出後にエフェクトをフェードアウト
                setTimeout(() => { effectLayer.style.opacity = "0"; }, 3000);
                setTimeout(() => showResult(res), 4000);
            }
        }, 60);
    }

    function showResult(res) {
        let loseCount = parseInt(localStorage.getItem('extinction_count') || '0');

        if(res.url === "DESTROY") {
            loseCount++;
            localStorage.setItem('extinction_count', loseCount);

            // ツンデレメッセージ判定
            let msg = "";
            if (loseCount === 1) msg = "あら、世界が滅亡しちゃった。また挑戦すればいいじゃない。";
            else if (loseCount === 2) msg = "あらら、また滅亡。運が悪いのね。私に会いに来たの？";
            else if (loseCount === 3) msg = "3回連続！？そんなに滅びたいのかしら？";
            else if (loseCount === 4) msg = "…4回。あなたのそのしぶとさ、嫌いじゃないわよ。";
            else msg = loseCount + "回も滅亡…もはや人間を超えてるわ。次は祈ってあげる。";

            alert(msg);

            document.getElementById('main-ui').style.visibility = 'hidden';
            const overlay = document.getElementById('result-overlay');
            overlay.style.display = 'flex';
            overlay.classList.add('doom-bg');
            document.getElementById('win-title').innerText = "世界滅亡";
            document.getElementById('win-title').classList.add('doom-text');
            document.getElementById('win-status').innerText = "FATAL ERROR: SYSTEM TERMINATED";
            document.getElementById('countdown').style.display = 'none';
            document.getElementById('destroy-btn-final').style.display = 'block';
            playSound(50, 'sawtooth', 2, 0.3);
        } else {
            // 当選時のメッセージ
            let winMsg = (loseCount >= 1) 
                ? loseCount + "回も滅亡したのに、よく諦めなかったわね。はい、ご褒美よ。" 
                : "あら、一発で成功？面白くないけど、進んでちょうだい。";
            
            alert(winMsg);
            localStorage.setItem('extinction_count', '0');

            const overlay = document.getElementById('result-overlay');
            overlay.style.display = 'flex';
            overlay.classList.add('miracle-bg');
            [523, 659, 783, 1046].forEach((f, i) => {
                setTimeout(() => playSound(f, 'square', 0.6, 0.1), i * 150);
            });
            
            let sec = 3;
            const cd = setInterval(() => {
                sec--;
                document.getElementById('countdown').innerText = `Amazonへ転送中... 残り${sec}秒`;
                if(sec <= 0) { clearInterval(cd); window.location.href = res.url; }
            }, 1000);
        }
    }

    function startTheEnd() {
        // インデックスページに戻る（再挑戦ループ）
        window.location.href = "index.html#support";
    }
</script>
</body>
</html>
